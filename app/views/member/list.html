<div class="row">
 <div class="col-md-12">
   <div class="box box-primary">
       <div class="box-header with-border">
         <h3 class="box-title">客户列表</h3>
           <form class="form-horizontal">
               <label for="memberName" class="col-sm-2 control-label">选择客户：</label>
               <div class="form-group col-sm-4 ">
                   <div class="input-group">
                       <input type="text" class="form-control" id="memberName"  placeholder="名称 或者 车牌">
                       <div class="input-group-btn">
                           <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                               <span class="caret"></span>
                           </button>
                           <ul class="dropdown-menu dropdown-menu-right" role="menu"></ul>
                       </div>
                   </div>
               </div>

               <label for="select3"  class="col-sm-2 control-label">客户类型：</label>
               <div class="form-group col-sm-4 ">
                   <select  id="select3" class="form-control" name="GroupType">
                       <option>请选择客户类型</option>
                       <option value="1">个人</option>
                       <option value="2">企业</option>
                   </select>
               </div>

               <label class="col-sm-2 control-label"></label>
               <div class="form-group  col-sm-4 ">
                   <button type="submit" class="btn btn-primary"><i class="fa   fa-search "></i>  查询 </button>
               </div>
           </form>
       </div>
       <div class='box-body'>
         <table id="data" class="table table-bordered table-striped">
               <thead>
               <tr>
                 <th>ID</th>
                 <th>客户名称</th>
                 <th>客户车牌</th>
                 <th>账户资金</th>
                 <th>录入时间</th>
                 <th>最近一次变更时时间</th>
                 <th>操作</th>
               </tr>
               </thead>
               <tfoot>
               <tr>
                 <th colspan="7" style="  text-align: right;color:red">总计:{{sum}} 元</th>
               </tr>
               </tfoot>
             </table>
           <button type="button" id="deleteData" class="btn  btn-danger"><i class="fa fa-minus "></i>删除选择订单 </button>
       </div>
       <div class='overlay tableLoading'><i class='fa fa-refresh fa-spin'></i></div>
   </div>
 </div>
</div>
<script>
  $(function () {

      $(function () {
          var jdatatables;
          $("#deleteData").click(function () {
              if(jdatatables){
                  var data = $(".DeleteOrderNos").filter(":checked");
                  if(data.length<=0) return;
                  var params={};
                  for(var i=0;i<data.length;i++){
                      params['o_'+i] = $(data[i]).val();
                  }
                  $(".tableLoading").show();
                  $.ajax({
                      type: "POST",
                      url: "ajaxDelete",
                      data: params,
                      dataType: 'json'
                  }).success(function (items) {
                      jdatatables.ajax.reload();
                  }).fail(function () {
                      jdatatables.ajax.reload();
                      alert("删除数据报错")
                  })
              }
          })

          function renderTable(options, render) {
              $(".tableLoading").show();
              var p = options.params();
              if(options.pageSize){
                  p.size = options.pageSize
              }
              if(options.pageCur){
                  p.cur = options.pageCur
              }
              $.ajax({
                  type: options.method || "GET",
                  url: options.url,
                  data: p,
                  dataType: 'json'
              }).success(function (items) {
                  render(options, items);
                  $(".tableLoading").hide();

              }).fail(function () {
                  $(".tableLoading").hide();
                  alert("查询数据报错")
              })
          }
          function dataTable(options, items) {
              jdatatables = $(options.target).DataTable({
                  "serverSide": true,
                  "ajax": function (data, callback) {
                      if (!options.row) {
                          callback({
                              draw: 0,
                              recordsTotal: items.data.total,
                              recordsFiltered: items.data.total,
                              data: items.data.orders
                          })
                          options.row = true;
                      } else {
                          options.pageSize = data.length;
                          options.pageCur = Math.ceil(data.start / data.length) + 1;
                          renderTable(options, function (opts, i) {
                              callback({
                                  recordsTotal: i.data.total,
                                  recordsFiltered: i.data.total,
                                  data: i.data.orders
                              })
                          })
                      }
                  },
                  "columns": options.columns,
                  "paging": true,
                  "lengthChange": true,
                  "searching": false,
                  "scrollX": true,
                  "ordering": false,
                  "showFoot": false,
                  "autoWidth": true,
                  "pagingType": "full_numbers",
                  "bFilter": false,
                  "columnDefs":[],
                  "language": {
                      sEmptyTable: "<b>符合条件的数据为空</b>",
                      sInfo: "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                      sInfoEmpty: "显示第 0 至 0 项结果，共 0 项",
                      sInfoFiltered: "(filtered from _MAX_ total entries)",
                      sInfoThousands: ",",
                      sLengthMenu: "显示 _MENU_ 项",
                      sLoadingRecords: "数据加载中，请稍后...",
                      sProcessing: "加载中...",
                      sSearch: "搜索:",
                      sZeroRecords: "未找到匹配的元素",
                      errMode: function (settings, tn, msg) {
                          console.log(msg)
                      },
                      oPaginate: {
                          sFirst: "首页",
                          sLast: "尾页",
                          sNext: "下页",
                          sPrevious: "上页"
                      },
                      oAria: {
                          sSortAscending: ": 以升序排列此列",
                          sSortDescending: ": 以降序排列此列"
                      }
                  }
              });
          }

          var DataTables = function (opts) {
              renderTable(opts, dataTable)
          }

          DataTables({
              target: "#data",
              url: "ajaxQuery",
              columns: [
                  {"data": "OrderNo"},
                  {"data": "OrderNo"},
                  {"data": "UserInfo"},
                  {"data": "Mobile"},
                  {"data": "Status"},
                  //  {"data": "RefundDepositStatus"},
                  {"data": "DeliverName"},
                  {"data": "DeliverNum"},
                  {"data": "DeviceNumber"},
                  {"data": "MaterialNumber"},
                  {"data": "UseDate"},
                  {"data": "CreateDate"},
                  {"data": "AddressInfo"},
                  {"data": "PromoteCode"},
                  {"data": "PromotePrice"},
                  {"data": "ServicePrice"},
                  //  {"data": "Deposit"},
                  {"data": "PayServiceAmount"},
                  //    {"data": "PayDepositAmount"},
                  {"data": "LastUpdateDate"}
              ], params:function () {
                  var obj=new Object();
                  $.each($('form').serializeArray(),function(index,param){
                      if(!(param.name in obj)){
                          if('请选择状态' !=param.value ){
                              obj[param.name]=param.value;
                          }
                      }
                  });
                  obj.size = 10;
                  obj.cur=1
                  return obj;
              }
          })

          $("form").on("submit",function (event) {
              event.preventDefault();
              jdatatables.ajax.reload();
          })
      });

      $("#memberName").bsSuggest({
          url: "{{ctx}}/member/suggest?name=",
          showBtn: true,
          idField: "MemberId",
          keyField: "Name",
          allowNoKeyword: true,
          getDataMethod: "url",
          processData: function (res){
              return {value: $.map(res,function (d) {
                  return{
                      "MemberId":d.MemberId,
                      "Name":d.Name
                  }
              })}
          },
          showHeader: true,
          effectiveFieldsAlias:{MemberId: 'ID', Name:'名称/车牌'}
      }).on('onSetSelectValue', function (e, data) {
          $("#memberName").next('input[type="hidden"]').remove()
          $("#memberName").after('<input type="hidden" name="MemberId" value="'+ data.id+'"/>')
      }).on('onUnsetSelectValue', function (e) {
          $("#memberName").val('')
          $("#memberName").next('input[type="hidden"]').remove()
      })

  });
</script>
